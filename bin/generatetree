#!/bin/bash

## This script takes as its input a file containing a list of 3Krice cultivars
## that have been input into the generatevcf script. This script merges the
## chromosomes in parallel, strips any sites that don't have SNPs, and
## concatenates them into a new VCF containing only the sites with SNPs. A
## subset of these SNPs are chosen at random and used as an alignment from which
## a maximum-likelihood tree is generated.

shopt -s extglob

# help menu
function usage() {
        echo "
                Code4Rice3K Help Section:
                =========================

                Usage: $0 -m <mode> -c <configfile> -i <listofcultivars> -o <path> -m --numproc <cpu_threads> --numdata <data_threads>
                Example: $0 -m local -c ~/Home/MyFiles/myconfigfile.conf -i mylist.txt -o ~/Downloads/ --numproc 12 --numdata 12
                
                1) Mandatory options:
                -m|--mode <string>               :       Either "local" if run locally, or "hpc" if run on HPC computer
                -i|--inputlist <textfile>	 :       List containing the names of all cultivars to be inferred

                2) Optional setings:
		-c|--configfile <path>		 :	 Configuration file for the code4Rice3K workflow
		-o|--outputdir <string>	         :	 Directory path for the output files
		--numproc <int>       		 :       The number of CPU threads used by GATK (4-12 is recommended)
                --numdata <int>      		 :       The number of data threads used by GATK (6-24 is recommended)
                --startfromstep <string>   	 :       Indicate the starting step, must be between step1-step4 (see below) 
                --stopatstep <string>      	 :       Indicate the last step, must be between step1-step4 (see below)
                --runonlystep <string>     	 :       Indicate a single step to run, e.g. step1 or step3 (see below)

                -h|--help                     	 :       Disply this help message

                code4Rice3K workflow can be run entirely or only part of the workflow can run.
                Below are the possible steps that can chosen for the "generatetree" script:

                step 1 merges each chromosome of every given cultivar 
                step 2 generates VCF file for the merged chromosomes, ATTN: To skip to this step, previous steps must have run successfully
                step 3 generates FASTA file, ATTN: To skip to this step, previous steps must have run successfully
                step 4 generates alignment file, ATTN: To skip to this step, previous steps must have run successfully
        "
}

if [ -z "$*" ]; then usage ; exit 1 ; fi

# Set default main and bin directories:
#scriptdir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
#maindir="$( cd "$( dirname "${BASH_SOURCE[0]}" )"/../ && pwd )"


# Set variable steps2run as an array
declare -a steps2run
steps2run=(step1 step2 step3 step4)
startfromstep=""
stopatstep=""
runonlystep=""

# Default option settings:
#outputdir=$maindir
#configfile=$scriptdir/code4Rice3K.conf

function readconfigfile {
if [ ! -e "$1" ] ; then
        echo ""
        echo "Fatal error: code4Rice3K config file $1 does not exist. Please check"
        exit 1
fi
raxmlOptions1=`grep '^raxmlOptions1=' "$1" | awk -F"=" '{print $2}'`
raxmlOptions2=`grep '^raxmlOptions2=' "$1" | awk -F"=" '{print $2}'`
}

# Parsing command line arguments:
OPTIONS=`getopt -o c:i:o:m:h --long configfile:,inputlist:,outputdir:,mode:,numproc:,numdata:,startfromstep,stopatstep:,runonlystep:,help -n 'code4Rice3K error' -- "$@"`
if [ $? !+ 0 ] ; then echo " " ; echo "Could not parse options (see above) ..." >&2 ; usage ; exit 1 ; fi

eval set -- "$OPTIONS"

while true ; do
        case "$1" in
                -m|--mode)
			case "$2" in
				-*) echo "Please provide a valid mode option to -m"; usage; exit 1 ;; 
                        	*) if [[ $2 == hpc ]]; then
                                	maindir="$PBS_O_WORKDIR"
					outputdir=$maindir
					configfile=$maindir/bin/code4Rice3K.conf
                                	echo "maindir=$maindir"
                                	echo "Loading modules"
                                	. /etc/profile.d/modules.sh >/dev/null 2>&1
                                	module load samtools java tabix bcftools vcftools/0.1.13 python >/dev/null 2>&1
                        	elif [[ $2 == local ]]; then
                                	maindir="$( cd "$( dirname "${BASH_SOURCE[0]}" )"/../ && pwd )"
					outputdir=$maindir
					configfile=$maindir/bin/code4Rice3K.conf
                                	echo "maindir=$maindir"
                        	else
                                	echo "Please provide a valid mode option to -m"; usage; exit 1
                        	fi ;;
			esac ;;

		-c|--configfile)
			case "$2" in
				-*) echo "Please load code4Rice3K configuation file"; usage; exit ;;
				*) configfile=$2; shift 2 ;;
                -i|--inputlist)
			case "$2" in
				-*) echo "Please provide a valid list with cultivar names when using -i"; usage; exit 1 ;;
				*) inputfile=$2 ; filename=${inputfile##*/} ; cultivarlist=$(cat $inputfile) ; shift 2 ;;
			esac ;;

		-o|--outputdir)
			case "$2" in
				-*) echo "Please designate an output path option when using -o"; usage; exit 1 ;;
				*) outputdir=$2 ; shift 2 ;;
			esac ;;

                --numproc)
			case "$2" in
				-*) echo "Please provide a valid integer for the number of cpu threads when using --nct"; usage; exit 1 ;;
                        	*) nct=$2 ; shift 2 ;;
			esac ;;

                --numdata)
			case "$2" in 
				-*) echo " please provide a valid integer for the number of data threads when using --nt"; usage; exit 1 ;;
                        	*) nt=$2 ; shift 2 ;;
			esac ;;

                --startfromstep)
			case "$2" in
				-*) echo "Please designate the code4Rice3K step from which to start"; usage; exit 1 ;;
                        	*) startfromstep=$2 ; shift 2 ;;
			esac ;;

                --stopatstep)
			case "$2" in
				-*) echo "Please designate the last code4Rice3K step to execute"; usage; exit 1 ;;
				*) stopatstep=$2 ; shift 2 ;;
			esac ;;

                --runonlystep)
			case "$2" in
				-*) echo "Please designate the code4Rice3K step to execute"; usage; exit 1 ;;
                        	*) runonlystep=$2 ; shift 2 ;;
			esac ;;

                h|--help)
                        usage; exit 1 ;;

		--) shift ; break ;;

		*) echo "Unknown option or error" ; usage; exit 1 ;;
        esac
done


# Step 0
echo ""
echo "=============================================================================="
echo " Setting up workflow ..."
echo "=============================================================================="
echo ""

bin=${maindir}/bin

data=${outputdir}/data
vcffiles=${data}/vcffiles
splitchromosomefiles=${data}/splitchromosomefiles
mergedchromosomefiles=${data}/mergedchromosomefiles
alignmentfiles=${data}/alignmentfiles

mkdir -p ${outputdir}/data
cd $data
mkdir -p $vcffiles $splitchromosomefiles $mergedchromosomefiles $alignmentfiles
cd $maindir

if [ ! -d "$outputdir" ] ; then
        echo ""
        echo "Fatal error: Output directory $outputdir does not exist. Please check"
        exit 1 
fi

readconfigfile $configfile

# Control which step to run:
runstep1=0
runstep2=0
runstep3=0
runstep4=0

if [[ $startfromstep != '' ]] ; then
	i=-1
	for step in ${steps2run[@]} ; do
		((++i))
		if [[ $step != $startfromstep ]] ; then unset steps2run[$i] ; else break ; fi
	done
fi

unsetflag=0
if [[ $stopatstep != '' ]] ; then
	for step in ${steps2run[@]} ; do
		((++i))
		if [[ $step == $stopatstep ]] ; then unsetflag=1 ; ((--i))
		else if [[ $unsetflag == 1 ]] ; then unset steps2run[$i] ; fi ; fi
	done
fi

if [[ $runonlystep != '' ]] ; then
	steps2run=($runonlystep)
fi

for step in ${steps2run[@]} ; do
  if [[ $step == "step1" ]] ; then runstep1=1 ; fi
  if [[ $step == "step2" ]] ; then runstep2=1 ; fi
  if [[ $step == "step3" ]] ; then runstep3=1 ; fi
  if [[ $step == "step4" ]] ; then runstep4=1 ; fi
done

cd $maindir

# Once all of the cultivars are cleaned and split, the chromosomes can be merged by vcf-merge.
# "bcftools merge" is supposed to be faster, but seems to have a problem with something in the format of these files.
# The merge function includes filters to remove any sites that don't have at least one alternate allele and one match to the reference, 
# as well as any "Multiple Nucleotide Polymorphism" sites.

# Step 1
if [[ runstep1 == 1 ]]; then
        echo ""
        echo "=============================================================================="
        echo "Step 1 Merging chromosomes ..."
        echo "=============================================================================="
        echo ""

	cd $splitchromosomefiles
	for chromosome in {chr01,chr02,chr03,chr04,chr05,chr06,chr07,chr08,chr09,chr10,chr11,chr12}; do
		merge_chromosome $chromosome &
	done
	echo "Finished merging chromosome"
	echo "" 
fi
wait

# Step 2
if [[ runstep2 == 1 ]]; then
        echo ""
        echo "=============================================================================="
        echo "Step 2 Assemble a VCF file containing all called SNPs ..."
        echo "=============================================================================="
        echo ""

	# After the chromosomes have been individually merged and cleaned, they can be reassembled into one VCF file containing 
	# all the sites that were called in all the input cultivars and contain at least one SNP.
	cd $mergedchromosomefiles
	vcf-concat chr*.cleaned.vcf.gz > ${filename%.*}.merge.cleaned.vcf
	
	# In order to make trees, random sites from the VCF are selected and turned into a FASTA alignment.
	# First the random sites are turned into a smaller VCF
	randomsubsetvcf ${filename%.*}.merge.cleaned.vcf 100000 > ../alignmentfiles/${filename%.*}.100000SNPs.vcf
	echo "Merged file created"
	echo ""
fi

# Step 3
if [[ runstep3 == 1 ]]; then
        echo ""
        echo "=============================================================================="
        echo "Step 3 Generating FASTA file for alignment ..."
        echo "=============================================================================="
        echo ""

	cd $alignmentfiles
	# Then the VCF is turned into a fasta file with a python script.
	python ${scriptdir}/snp2seq.py ${filename%.*}.100000SNPs.vcf
	echo "Fasta file created"
	echo ""
fi

# Step 4
if [[ runstep4 == 1 ]]; then
        echo ""
        echo "=============================================================================="
        echo "Step 4 Generating alignment ..."
        echo "=============================================================================="
        echo ""
	
	cd $alignmentfiles
	fasta="${alignmentfiles}/${filename%.*}.100000SNPs.vcf.fasta"
	rm -f RAxML_${filename%.*}.ERROR
	rm -f RAxML_${filename%.*}.log
	rm -f RAxML*${filename%.*}*

	## Model ASC_GTRGAMMA must be used to correct for the fact that we're only using SNPs

	# -f d means rapid hill-climbing algorithm
	#raxmlHPC -f d -m ASC_GTRGAMMA --asc-corr=lewis -n ${fasta%%.vcf.fasta} -p 12345 -s ${fasta} 2>&1 > RAxML_${fasta%%.vcf.fasta}.log || touch RAxML_${fasta%%.vcf.fasta}.ERROR

	# Version for Karst/Carbonate. PTHREADS version w/ 12 threads. This REQUIRES at least 12 processors.
	raxmlHPC-PTHREADS ${raxmlOptions1} -n ${filename%.*} -p 12345 -s ${fasta} 2>&1 > RAxML_${filename%.*}.log || raxmlHPC-PTHREADS ${raxmlOptions2} -n ${filename%.*} -s ${fasta} 2>&1 > RAxML_${filename%.*}.log || touch RAxML_${filename%.*}.ERROR
	echo "RAxML alignment file created"
	echo ""
fi

# -f a means bootstrap analysis and bestTree in one run.
#raxmlHPC -f a -m ASC_GTRGAMMA --asc-corr=lewis -n ${fasta%%.vcf.fasta} -N 100 -p 12345 -s ${fasta} -x 12345 2>&1 > RAxML_${fasta%%.vcf.fasta}.log || touch RAxML_${fasta%%.vcf.fasta}.ERROR

# This can go a lot faster with openmpi
#mpirun -n 6 raxmlHPC-MPI-AVX -f a -m ASC_GTRGAMMA --asc-corr=lewis -n ${fasta%%.vcf.fasta} -N 1000 -p 12345 -s ${fasta} -x 12345 2>&1 > RAxML_${fasta%%.vcf.fasta}.log || touch RAxML_${fasta%%.vcf.fasta}.ERROR

echo ""
echo "=============================================================================="
echo " Finished generating files"
echo "=============================================================================="
echo ""

exit
